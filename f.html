<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Dreamer (B) — Receiver</title>
  <style>
    body { font-family: system-ui; padding: 20px; }
    pre { white-space: pre-wrap; background: #f4f4f4; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Dreamer (B) — Receiver</h2>
  <div id="status">Waiting for auth message or reading stored data...</div>
  <pre id="stored"></pre>

<script>
const TRUSTED_A_ORIGIN = 'http://localhost:6700';  // change to your A.com origin
const STORAGE_KEY = 'login_data';

/* Save directly */
function saveAuth(obj) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
}

/* Read stored */
function readAuth() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null;
  } catch {
    return null;
  }
}

/* Display stored data */
function renderStored() {
  const data = readAuth();
  const el = document.getElementById('stored');
  const status = document.getElementById('status');
  if (!data) {
    status.textContent = 'No stored auth found.';
    el.textContent = '';
  } else {
    status.textContent = 'Stored auth data:';
    el.textContent = JSON.stringify(data, null, 2);
  }
}

/* Receive message */
window.addEventListener('message', (ev) => {
  if (ev.origin !== TRUSTED_A_ORIGIN) {
    console.warn('Ignored message from', ev.origin);
    return;
  }
  const data = ev.data || {};
  if (data.type === 'auth' && data.userData) {
    saveAuth(data.userData);
    // send acknowledgement back
    if (ev.source && ev.source.postMessage) {
      ev.source.postMessage({ type: 'auth-ack' }, ev.origin);
    }
    document.getElementById('status').textContent = 'Auth received and stored.';
    renderStored();
  }
});

/* On load, show existing data */
window.addEventListener('load', renderStored);

/* Clear button */
window.clearStoredAuth = () => {
  localStorage.removeItem(STORAGE_KEY);
  renderStored();
};
</script>

<hr />
<button onclick="clearStoredAuth()">Clear stored auth (for test)</button>
</body>
</html>
